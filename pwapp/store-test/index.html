<html>
    
    <body>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.9.0/localforage.js" integrity="sha512-JrJyNknk6qY0sNOPg9LsktBNM+6J4dukn3u1mX2tEY8+BvO+vLCpASMt21HPrn30Ow08wbafPnKoMyrQ5tovJA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script>
        
           const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            
            if (!localStorage.test) {
                localStorage.test = Math.random().toString(36).substr(-8);
                console.log("defined:localStorage.test="+localStorage.test);
            } else {
                console.log("retreived:localStorage.test="+localStorage.test);
            }
            
            if (!document.cookie) {
                document.cookie = Math.random().toString(36).substr(-8);
                console.log("defined:document.cookie="+document.cookie);
            } else {
                console.log("retreived:document.cookie="+document.cookie);
            }
            
            localforage.getItem('test', function (err, value) {
                if (err) {
                   console.log("error getting localForage:",err);
                }
                 if (value) {
                     console.log("retreived:localForage.test="+value);
                 } else {
                     localforage.setItem('test', Math.random().toString(36).substr(-8), function (err) {
                         if (err) {
                             console.log("error setting localForage:",err);
                          }
                          localforage.getItem('test', function (err, value) {
                              if (err) {
                                 console.log("error getting localForage:",err);
                              }
                               if (value) {
                                   console.log("defined:localForage.test="+value);
                               } 
                          });
                     });
                 }
            });
            
            
            function backup (cb) {
                const data = {
                    local : {},
                    forage : {}
                }
                Object.keys(localStorage).forEach(function(k){
                    data.local[k]=localStorage.getItem(k);
                }); 
                
                localforage.keys().then(function(keys){
                    Promise.all(keys.map(function(k){
                      return localStorage.getItem(k);
                    }).then(function(values){
                        keys.forEach(function(k,ix){
                            data.forage[k]=values[ix];
                        });
                        
                        cb(data);
                    })
                    ; 
                });
                
            }
            

            function restore (data,cb ) {
                try {
                    Object.keys(data.local).forEach(function.(k){
                        localStorage.setItem(k,data.local[k]);
                    }); 
                } catch (e) {
                    return cb(e);
                }
                
                Promise.all(Object.keys(data.forage).map(function(k){
                                return localforage.setItem(k,data.local[k]);
                            })).then(function(){
                    cb ();
                }).catch(cb);
                

            }
            
            
            function serverCmd(id,cmd,data,cb) {
                const salt = "wkjsdfksnfknaskfjfjksfd86783ikjenbf";
                const json = JSON.stringify(data);
                sha1SubtleCB(new TextEncoder().encode(id+json+salt),function(){
                    const payload = JSON.stringify({
                        id,msg,cmd,data
                    });
                    
                    var xhr = new XMLHttpRequest(); 
                    xhr.open("POST", "https://pollen-diamond-cone.glitch.me/storage");
                    xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                    
                    xhr.onerror=function(){
                        cb(new Error("xhr error"));
                    };
                    
                    xhr.onreadystatechange = function () {
                       if (xhr.readyState === 4) {
                          if(xhr.status===200) {
                                try {
                                   cb(undefined,JSON.parse(xhr.responseText));
                               catch(e) {
                                   cb(e);
                               }
                          }
                       }};
                       
                    xhr.send(payload);
                });  
            }
            
            
            function sha1SubtleCB(buffer,cb){ 
                    return crypto.subtle.digest("SHA-1", buffer)
                       .then(function(dig){cb(undefined,bufferToHex(dig));})
                         .catch(cb); 
                
            }
            
            const id = urlParams.get('id');
            if (id) {
                serverCmd(id,"getItem",Math.random().toString(36).substr(-8),function(err,data){
                   console.log(err,data);
                });
            }
           
            
        </script>
        
    </body>
</html>